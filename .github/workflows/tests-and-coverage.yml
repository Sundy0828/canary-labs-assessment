name: Test and Upload Coverage
on: [push, pull_request]

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET 8
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 8.0.x

            - name: Restore
              run: dotnet restore

            - name: Build
              run: dotnet build --no-restore --configuration Release

            - name: Test with coverage
              run: dotnet test --no-build --configuration Release --collect:"XPlat Code Coverage" --results-directory "./TestResults"

            - name: Convert coverage to lcov
              uses: danielpalme/ReportGenerator-GitHub-Action@v5
              with:
                  reports: "TestResults/**/*.xml"
                  targetdir: "coverage"
                  reporttypes: "lcov"

            - name: Upload to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: "coverage/lcov.info"
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: unittests
                  fail_ci_if_error: true
